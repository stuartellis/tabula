---
stages:
  - release

variables:
  PIP_CACHE_DIR: $CI_PROJECT_DIR/.cache/pip
  PIP_ROOT_USER_ACTION: ignore

semantic-release:
  stage: release
  image: python:3.14-slim-trixie

  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
    GIT_AUTHOR_NAME: "GitLab CI"
    GIT_AUTHOR_EMAIL: "$GITLAB_USER_EMAIL"
    GIT_COMMITTER_NAME: "GitLab CI"
    GIT_COMMITTER_EMAIL: "$GITLAB_USER_EMAIL"

  before_script:
    - apt-get -qy update
    - apt-get install -qy git
    - pip install python-semantic-release==10.5.2
    - git config --global user.name "GitLab CI"
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git checkout -B "$CI_COMMIT_REF_NAME"

  script:
    - semantic-release version --print
    - semantic-release version
    - semantic-release changelog
    - semantic-release publish

  cache:
    paths:
      - ${PIP_CACHE_DIR}

  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: on_success
